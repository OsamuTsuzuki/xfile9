<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flip Book</title>
    <style>
        body {
            background-color: #f9f9f9;
            color: #333;
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        #display {
            display: block;
            margin: 0 auto;
        }

        .title {
            font-size: 1.5em;
            margin: 20px 0 10px;
        }

        .description {
            text-align: left;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        #helpText {
            text-align: left;
            background-color: #eee;
            padding: 10px;
            margin-bottom: 30px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        footer {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <img id="display" src="" alt="Display Image" />
        
        <div class="title">北海道　層雲峡c</div>
        
        <div class="description">
            層雲峡の河原にて撮影
            <ul>
                <li>表示画素：Circle, 全方位画像、480×480、表示水平画角：360度</li>
                <li>撮影：大手明 (東京都） Akira Ohte, Tokyo, Japan</li>
                <li>撮影地：Hokkaido,　JAPAN</li>
                <li>撮影年月：2004年7月</li>
                <li>球面ミラー全方位カメラ：自作実験機、ミラー径 6cm</li>
                <li>デジタルカメラ：Canon PowerShot A80, 4M pixels</li>
                <li>Av：5.0, Tv：1/40, ISO：50</li>
            </ul>
        </div>

        <label>
            <input type="checkbox" id="helpToggle" onchange="toggleHelp()">
            ヘルプを表示
        </label>

        <div id="helpText" hidden>
Hキー： ⬅️ パンレフト/自動パン停止  
Jキー： ⬇️ ティルトダウン  
Kキー： ⬆️ ティルトアップ  
Lキー： ➡️ パンライト/自動パン停止  
Shift + H： ◀️ 自動パンレフト  
Shift + L： ▶️ 自動パンライト  
Iキー： 🔍➕ ズームイン  
Oキー： 🔎➖ ズームアウト  
Nキー： ↕️ ティルトリセット  
Ctrl + R： ↩️ イニシャルポジション
        </div>

        <footer>
            Copyright (c) 2007 - 2025 Akira Ohte, All rights reserved. コピー、転載、禁止
        </footer>
    </div>

    <script>
        const htmlFilename = window.location.pathname.split("/").pop();
        const jsonFilename = htmlFilename.replace(".html", ".json");

        fetch(`${jsonFilename}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(configList => {
            const config = configList[0]; // 配列の最初の要素を取得
            const img = document.getElementById('display');
            // console.log(config.twidth);
            // console.log(config.theight);
            img.width = config.twidth;
            img.height = config.theight;
        })
        .catch(error => {
            console.error("Failed to get JSON:", error);
        });

        function toggleHelp() {
            const checkbox = document.getElementById('helpToggle');
            const help = document.getElementById('helpText');
            help.hidden = !checkbox.checked;
        }

        const templateKey = location.pathname.split('/').pop().replace(/\.html$/, '');
        function makeImageUrl(effect) {
            const timestamp = new Date().getTime();
            return `/process_image?template=${templateKey}&effect=${effect}&t=${timestamp}`;
        }

        let effectLevel = 3;
        let updateInterval = null;
        let autoRotate = false;
        let autoRotateDirection = 5;
        let highResTimeout = null;
        let isBusy = false;

        function updateImage() {
            if (isBusy) return;
            isBusy = true;

            const img = document.getElementById("display");
            const url = makeImageUrl(effectLevel);

            img.onload = () => { isBusy = false; };
            img.onerror = () => { isBusy = false; };

            img.src = url;

            if (![0, 5].includes(effectLevel)) {
                if (highResTimeout) clearTimeout(highResTimeout);
                highResTimeout = setTimeout(() => {
                    if (!isBusy) {
                        const highResUrl = makeImageUrl(1);
                        img.onload = () => { isBusy = false; };
                        img.onerror = () => { isBusy = false; };
                        img.src = highResUrl;
                    }
                    highResTimeout = null;
                }, 600);
            }
        }

        function startRotation(direction) {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(() => {
                effectLevel = direction;
                updateImage();
            }, 125);
        }

        document.addEventListener("keydown", (event) => {
            if (event.repeat) return;

            const normalKeys = {
                "h": 4,
                "j": 2,
                "k": 8,
                "l": 6,
                "i": 7,
                "o": 9
            };

            if (event.key in normalKeys && !event.shiftKey) {
                effectLevel = normalKeys[event.key];
                autoRotate = false;
                updateImage();
                if (!updateInterval) {
                    updateInterval = setInterval(() => updateImage(), 125);
                }
            }
            else if (event.key === "L" && event.shiftKey) {
                autoRotate = true;
                autoRotateDirection = 6;
                startRotation(autoRotateDirection);
            }
            else if (event.key === "H" && event.shiftKey) {
                autoRotate = true;
                autoRotateDirection = 4;
                startRotation(autoRotateDirection);
            }
            else if (event.key === "n" && !event.shiftKey) {
                effectLevel = 5;
                autoRotate = false;
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
                updateImage();
            }
            else if ((event.key === "r" || event.key === "R") && event.ctrlKey) {
                effectLevel = 0;
                autoRotate = false;
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
                updateImage();
            }
        });

        document.addEventListener("keyup", (event) => {
            if (["h", "j", "k", "l", "i", "o"].includes(event.key) && !event.shiftKey) {
                if (!autoRotate && updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }

            if (["h", "l"].includes(event.key) && !event.shiftKey && autoRotate) {
                autoRotate = false;
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }
        });

        window.addEventListener("DOMContentLoaded", () => {
            const img = document.getElementById("display");
            img.src = makeImageUrl(1);
        });
    </script>
</body>
</html>
